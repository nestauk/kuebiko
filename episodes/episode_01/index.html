
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="An example ds-cookiecutter project with associated guides for idiomatic development.">
      
      
      
      
        <link rel="canonical" href="https://nestauk.github.io/kuebiko/episodes/episode_01/">
      
      <link rel="icon" href="../../favicon.ico">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-7.3.4">
    
    
      
        <title>01 - Metaflow basics - ds-cookiecutter guide</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.db9e7362.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.3f5d1f46.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      


    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="pink" data-md-color-accent="amber">
  
    
    <script>function __prefix(e){return new URL("../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
      <script>var palette=__get("__palette");if(null!==palette&&"object"==typeof palette.color)for(var key in palette.color)document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#1-metaflow-basics-fetching-auxillary-data-from-the-web" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="https://nestauk.github.io/kuebiko" title="ds-cookiecutter guide" class="md-header__button md-logo" aria-label="ds-cookiecutter guide" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            ds-cookiecutter guide
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              01 - Metaflow basics
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="pink" data-md-color-accent="amber"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="amber" data-md-color-accent="pink"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/nestauk/kuebiko/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    nestauk/kuebiko
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://nestauk.github.io/kuebiko" title="ds-cookiecutter guide" class="md-nav__button md-logo" aria-label="ds-cookiecutter guide" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    ds-cookiecutter guide
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/nestauk/kuebiko/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    nestauk/kuebiko
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../pycco/" class="md-nav__link">
        Annotated Python source
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
        
          
            
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../">Episodes</a>
          
            <label for="__nav_3">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Episodes" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Episodes
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          01 - Metaflow basics
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        01 - Metaflow basics
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#standard-industrial-taxonomy-sic" class="md-nav__link">
    Standard Industrial Taxonomy (SIC)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#national-statistics-postcode-lookup-nspl" class="md-nav__link">
    National Statistics Postcode Lookup (NSPL)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#companies-house" class="md-nav__link">
    Companies House
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a-short-investigation-into-artifact-overheads" class="md-nav__link">
    A short investigation into artifact overheads
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" data-md-state="indeterminate" type="checkbox" id="__nav_4" checked>
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4">
          Condensed guides
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Condensed guides" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Condensed guides
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/metaflow/" class="md-nav__link">
        Metaflow
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../glossary/" class="md-nav__link">
        Glossary
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#standard-industrial-taxonomy-sic" class="md-nav__link">
    Standard Industrial Taxonomy (SIC)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#national-statistics-postcode-lookup-nspl" class="md-nav__link">
    National Statistics Postcode Lookup (NSPL)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#companies-house" class="md-nav__link">
    Companies House
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a-short-investigation-into-artifact-overheads" class="md-nav__link">
    A short investigation into artifact overheads
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/nestauk/kuebiko/edit/master/docs/guide/episodes/episode_01.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="1-metaflow-basics-fetching-auxillary-data-from-the-web">1. Metaflow basics - fetching auxillary data from the web<a class="headerlink" href="#1-metaflow-basics-fetching-auxillary-data-from-the-web" title="Permanent link">&para;</a></h1>
<p><img alt="⚠" class="twemoji" src="https://twemoji.maxcdn.com/v/latest/svg/26a0.svg" title=":warning:" /> This is not a Metaflow tutorial! It is assumed that you have already looked through the <a href="https://docs.metaflow.org/getting-started/tutorials">official Metaflow tutorials</a> and familiarised yourself with the <a href="https://docs.metaflow.org/">Metaflow docs</a>.</p>
<h2 id="standard-industrial-taxonomy-sic">Standard Industrial Taxonomy (SIC)<a class="headerlink" href="#standard-industrial-taxonomy-sic" title="Permanent link">&para;</a></h2>
<p>The first dataset that is fetched and processed is an Excel spreadsheet containing the codes and names of each of the 5 levels of the Standard Industrial Classification (SIC) taxonomy.
Later in the project when we come to analyse whether industry has an effect on the performance of a business' website this will be done using the SIC taxonomy - it's important that we are able to convert the (zero-padded) numeric codes into their description names when interpreting and reporting results.</p>
<p>The flow code can found in <a href="../../pycco/kuebiko/pipeline/sic/flow.html"><code>kuebiko/pipeline/sic/flow.py</code>*</a> and its utility functions (which are not a focus of this episode) in <a href="../../pycco/kuebiko/pipeline/sic/utils.html"><code>kuebiko/pipeline/sic/utils.py</code></a>.</p>
<p>Lets recap a few Metaflow commands:</p>
<ul>
<li>
<p><code>python kuebiko/pipeline/sic/flow.py show</code> will give us the docstrings and basic structure of the flow.</p>
</li>
<li>
<p><code>python kuebiko/pipeline/sic/flow.py run</code> will run the flow.</p>
</li>
<li>
<p><code>python kuebiko/pipeline/sic/flow.py dump &lt;run id&gt;/end</code> will dump a summary of the artifacts for a given run ID.</p>
</li>
</ul>
<div class="admonition info">
<p class="admonition-title">Metaflow defaults</p>
<p><code>.envrc</code> specifies:</p>
<ul>
<li><code>METAFLOW_DEFAULT_DATASTORE=local</code></li>
<li><code>METAFLOW_PROFILE=ds-cookiecutter</code></li>
</ul>
<p><a href="https://direnv.net/"><code>direnv</code></a> automatically loads these environment variables (after you run <code>direnv allow</code> - a security mechanism to avoid changes to <code>.envrc</code> automatically executing unsafe code).</p>
<p>The end effect is that Metaflow will use the configuration in <code>~/.metaflowconfig/config_ds-cookiecutter.json</code> that <code>ds-cookiecutter</code> sets up, and then override the default datastore to be local (data artifacts are persisted on your local machine in a <code>.metaflow/</code> folder not to S3).</p>
</div>
<ul>
<li>
<p><code>python kuebiko/pipeline/sic/flow.py --datastore=s3 run</code> will run the flow storing artifacts in S3 (rather than locally).</p>
</li>
<li>
<p><code>python kuebiko/pipeline/sic/flow.py --datastore=s3 --production run</code> will run the flow storing artifacts in S3 (rather than locally) under a production namespace.</p>
</li>
</ul>
<p><a href="../../pycco/kuebiko/getters/sic.html"><code>kuebiko/getters/sic.py</code>*</a> implements a getter function to load the lookups from our flow.
Writing a getter may seem to be an uneccessary level of indirection; however it is important to have this level of indirection because <code>getters</code>:</p>
<ul>
<li>Allows us to create derived views of data where Metaflow artifacts may not map 1:1 to getter functions</li>
<li>Provides a place to go to discover what data is available for <em>analysis</em> along in a logical folder/file structure with clear doc-strings per function<ul>
<li><strong>It is very important that getters relate to the problem domain</strong>, <br><code>get_csv_table(filename: str) -&gt; DataFrame</code> is not a valid getter, it's a utility function at best!</li>
</ul>
</li>
<li>Enables the possibility of extra data validation before returning to the user</li>
</ul>
<h2 id="national-statistics-postcode-lookup-nspl">National Statistics Postcode Lookup (NSPL)<a class="headerlink" href="#national-statistics-postcode-lookup-nspl" title="Permanent link">&para;</a></h2>
<p>The second dataset that is fetched and processed is the National Statistics Postcode Lookup (NSPL), a lookup from UK postcodes to various statistical geographies.</p>
<p>In this project we wish to extract the Local Authority District (variably referred to as LAD or LAUA), latitude, and longitude of each postcode.
The Local Authority Districts will enable spatial aggregation of businesses to a level at which official statistics relating to the number of businesses in each SIC code in a given area.
The latitude and longitude will enable other activities such as plotting.</p>
<p>The flow code can found in <a href="../../pycco/kuebiko/pipeline/nspl/flow.html"><code>kuebiko/pipeline/nspl/flow.py</code>*</a>, its utility functions (which are not a focus of this episode) in <a href="../../pycco/kuebiko/pipeline/nspl/utils.html"><code>kuebiko/pipeline/nspl/utils.py</code></a>, and its getters in <a href="../../pycco/kuebiko/getters/nspl.html"><code>kuebiko/getters/nspl.py</code>*</a></p>
<div class="admonition info inline end">
<p class="admonition-title">Info</p>
<p>If a flow uses one of Metaflow's Conda decorators, or <code>--with conda</code> at runtime then it must run with <code>--environment=conda</code>.</p>
</div>
<p>Running <code>python kuebiko/pipeline/nspl/flow.py --environment=conda run</code> will run the flow.</p>
<h2 id="companies-house">Companies House<a class="headerlink" href="#companies-house" title="Permanent link">&para;</a></h2>
<p>The third dataset that is fetched and processed is the Companies House (UK company registrar) monthly data dump.</p>
<p>Each registered UK company has a company number. By finding company numbers on websites we can match companies to Companies House obtaining information such as the SIC code they classify their activities as and their registered trading addresses.</p>
<p>The flow code can found in <a href="../../pycco/kuebiko/pipeline/companies_house/flow.html"><code>kuebiko/pipeline/companies_house/flow.py</code>*</a>, its utility functions (which are not a focus of this episode) in <a href="../../pycco/kuebiko/pipeline/companies_house/utils.html"><code>kuebiko/pipeline/companies_house/utils.py</code></a>, and its getters in <a href="../../pycco/kuebiko/getters/companies_house.html"><code>kuebiko/getters/companies_house.py</code>*</a>
.</p>
<p>Running <code>python kuebiko/pipeline/companies_house/flow.py run</code> will run the flow.</p>
<h2 id="a-short-investigation-into-artifact-overheads">A short investigation into artifact overheads<a class="headerlink" href="#a-short-investigation-into-artifact-overheads" title="Permanent link">&para;</a></h2>
<p>In <a href="../../pycco/kuebiko/pipeline/sic/flow.html"><code>kuebiko/pipeline/sic/flow.py</code>*</a> we talked about the size of metaflow steps and the fact that persisting artifacts with the S3 datastore has some overhead, but how much?</p>
<p>The Companies House dataset is quite large (several GB of RAM as a Pandas dataframe), so lets use this to explore the slowdown we might see close to the worst case (also comparing to plain Python <a href="../../pycco/kuebiko/pipeline/companies_house/script.html"><code>kuebiko/pipeline/companies_house/script.py</code>*</a> whilst we're here):</p>
<ul>
<li>
<p><code>time python kuebiko/pipeline/companies_house/flow.py run --max-workers 1</code></p>
<p>~10 minutes</p>
</li>
<li>
<p><code>time python kuebiko/pipeline/companies_house/script.py</code></p>
<p>~10 minutes</p>
</li>
<li>
<p><code>time python kuebiko/pipeline/companies_house/flow.py --datastore=s3 run --max-workers 1</code></p>
<p>~26 minutes</p>
</li>
<li>
<p><code>time python kuebiko/pipeline/companies_house/flow.py run --max-workers 4</code></p>
<p>~4 minutes</p>
</li>
<li>
<p><code>time python kuebiko/pipeline/companies_house/flow.py --datastore=s3 run --max-workers 4</code></p>
<p>~19 minutes</p>
</li>
</ul>
<p>Firstly, we see that Metaflow is the same speed as the plain Python script when
running on one core. We might expect Metaflow to be a little slower because it
has to serialise and deserialise artifacts between steps. Metaflow is twice as
fast when we allow up to 4 steps to execute at once - free parallelism as long
as we have the RAM to spare!</p>
<p>Next, comparing the local datastore to the S3 datastore, we see a rather large slowdown of 2.5x (5x with more parallelism)!<br>
Do not despair:</p>
<ul>
<li>This was picked as a particularly bad case</li>
<li>In reality, you only need to pay this cost once when your feature is complete and you run with <code>--production --datastore=s3</code>. During testing/development you can use <code>--datastore=local</code> (or if you specify <code>METAFLOW_DEFAULT_DATASTORE=local</code> in <code>.envrc</code> then you don't need to explicitly choose this)</li>
<li>If the flow was run on batch, which requires the S3 datastore, (covered in a later episode) then the download and upload speeds would be faster and the slowdown not so severe</li>
<li>
<p>If all else fails you can always use the local datastore and use <a href="https://docs.metaflow.org/metaflow/data#data-in-s3-metaflow.s3"><code>metaflow.S3</code></a> to save and share the necessary data at the end of the flow</p>
<ul>
<li><img alt="📓" class="twemoji" src="https://twemoji.maxcdn.com/v/latest/svg/1f4d3.svg" title=":notebook:" /> Note: You should use the <code>self</code> context, i.e. <code>with S3(run=self) as s3: ...</code> so that data is versioned under the current run ID and doesn't risk overwriting someone else's version of the data.</li>
</ul>
</li>
</ul>
                
              
              
                


              
            </article>
          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" data-md-state="hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg>
            Back to top
          </a>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../" class="md-footer__link md-footer__link--prev" aria-label="Previous: Episode overview" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Episode overview
            </div>
          </div>
        </a>
      
      
        
        <a href="../../guides/metaflow/" class="md-footer__link md-footer__link--next" aria-label="Next: Metaflow" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Metaflow
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        
          Made with
          <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
            Material for MkDocs
          </a>
        
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.tracking", "navigation.sections", "navigation.top", "navigation.expand", "navigation.indexes"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.8397ff9e.min.js", "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.1e84347e.min.js"></script>
      
    
  </body>
</html>