<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>utils.py</title>
  <link rel="stylesheet" href="../../../pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div class='section'>
    <div class='docs'><h1>utils.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;Extracting SIC code structure lookups from Excel.&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">toolz</span> <span class="kn">import</span> <span class="n">interleave</span>

<span class="n">LEVELS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;section&quot;</span><span class="p">,</span> <span class="s2">&quot;division&quot;</span><span class="p">,</span> <span class="s2">&quot;group&quot;</span><span class="p">,</span> <span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;subclass&quot;</span><span class="p">]</span>
<span class="n">EXPECTED_COLUMNS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;section&quot;</span><span class="p">,</span>
    <span class="s2">&quot;section_name&quot;</span><span class="p">,</span>
    <span class="s2">&quot;division&quot;</span><span class="p">,</span>
    <span class="s2">&quot;division_name&quot;</span><span class="p">,</span>
    <span class="s2">&quot;group&quot;</span><span class="p">,</span>
    <span class="s2">&quot;group_name&quot;</span><span class="p">,</span>
    <span class="s2">&quot;class&quot;</span><span class="p">,</span>
    <span class="s2">&quot;class_name&quot;</span><span class="p">,</span>
    <span class="s2">&quot;subclass&quot;</span><span class="p">,</span>
    <span class="s2">&quot;subclass_name&quot;</span><span class="p">,</span>
<span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Get SIC 2007 structure from ONS hosted excel file.&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">excel_to_df</span><span class="p">(</span><span class="n">content</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Parse Excel to Dataframe.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span>
            <span class="n">content</span><span class="p">,</span>
            <span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">names</span><span class="o">=</span><span class="n">interleave</span><span class="p">([</span><span class="n">LEVELS</span><span class="p">,</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">_name&quot;</span><span class="p">,</span> <span class="n">LEVELS</span><span class="p">)]),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">column</span><span class="p">:</span> <span class="n">column</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">fill</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Fill missing information in spreadsheet.</span>

<span class="sd">    Go from:</span>

<span class="sd">    ```</span>
<span class="sd">    [</span>
<span class="sd">        [&quot;A&quot;, &quot;Agri&quot;, nan, nan, nan, nan, nan, nan, nan, nan],</span>
<span class="sd">        [nan, nan, &quot;01&quot;, &quot;Crop&quot;, nan, nan, nan, nan, nan, nan],</span>
<span class="sd">        [nan, nan, nan, nan, &quot;01.1&quot;, &quot;Grow&quot;, nan, nan, nan, nan],</span>
<span class="sd">        [nan, nan, nan, nan, nan, nan, &quot;01.11&quot;, &quot;Grow&quot;, nan, nan],</span>
<span class="sd">        [nan, nan, nan, nan, nan, nan, nan, nan, &quot;01.11/xx&quot;, &quot;Extra&quot;],</span>
<span class="sd">        [nan, nan, nan, nan, nan, nan, &quot;01.12&quot;, &quot;Grow&quot;, nan, nan],</span>
<span class="sd">        [nan, nan, nan, nan, &quot;01.2&quot;, &quot;Grow&quot;, nan, nan, nan, nan],</span>
<span class="sd">        [nan, nan, nan, nan, nan, nan, &quot;01.21&quot;, &quot;Grow&quot;, nan, nan],</span>
<span class="sd">        [nan, nan, &quot;02&quot;, &quot;Forest&quot;, nan, nan, nan, nan, nan, nan],</span>
<span class="sd">        [nan, nan, nan, nan, &quot;02.1&quot;, &quot;Silvi&quot;, nan, nan, nan, nan],</span>
<span class="sd">        [nan, nan, nan, nan, nan, nan, &quot;02.10&quot;, &quot;Silvi&quot;, nan, nan],</span>
<span class="sd">        [&quot;B&quot;, &quot;Mini&quot;, nan, nan, nan, nan, nan, nan, nan, nan],</span>
<span class="sd">        [nan, nan, &quot;05&quot;, &quot;Mini&quot;, nan, nan, nan, nan, nan, nan],</span>
<span class="sd">        [nan, nan, nan, NOTE, nan, nan, nan, nan, nan, nan],</span>
<span class="sd">        [nan, nan, nan, nan, &quot;05.1&quot;, &quot;Mini&quot;, nan, nan, nan, nan],</span>
<span class="sd">        [nan, nan, nan, nan, nan, nan, &quot;05.10&quot;, &quot;Mini&quot;, nan, nan],</span>
<span class="sd">    ]</span>
<span class="sd">    ```</span>

<span class="sd">    To:</span>

<span class="sd">    ```</span>
<span class="sd">    [</span>
<span class="sd">        [&quot;A&quot;, &quot;Agri&quot;, &quot;01&quot;, &quot;Crop&quot;, &quot;01.1&quot;, &quot;Grow&quot;, &quot;01.11&quot;, &quot;Grow&quot;, &quot;01.11/xx&quot;, &quot;Extra&quot;],</span>
<span class="sd">        [&quot;A&quot;, &quot;Agri&quot;, &quot;01&quot;, &quot;Crop&quot;, &quot;01.1&quot;, &quot;Grow&quot;, &quot;01.12&quot;, &quot;Grow&quot;, &quot;01.12/0&quot;, &quot;Grow&quot;],</span>
<span class="sd">        [&quot;A&quot;, &quot;Agri&quot;, &quot;01&quot;, &quot;Crop&quot;, &quot;01.2&quot;, &quot;Grow&quot;, &quot;01.21&quot;, &quot;Grow&quot;, &quot;01.21/0&quot;, &quot;Grow&quot;],</span>
<span class="sd">        [&quot;A&quot;, &quot;Agri&quot;, &quot;02&quot;, &quot;Forest&quot;, &quot;02.1&quot;, &quot;Silvi&quot;, &quot;02.10&quot;, &quot;Silvi&quot;, &quot;02.10/0&quot;, &quot;Silvi&quot;],</span>
<span class="sd">        [&quot;B&quot;, &quot;Mini&quot;, &quot;05&quot;, &quot;Mini&quot;, &quot;05.1&quot;, &quot;Mini&quot;, &quot;05.10&quot;, &quot;Mini&quot;, &quot;05.10/0&quot;, &quot;Mini&quot;],</span>
<span class="sd">    ]</span>
<span class="sd">    ```</span>
<span class="sd">    &quot;&quot;&quot;</span>  <span class="c1"># noqa: B950</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">df</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">_drop_notes</span><span class="p">)</span>
        <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">_generic_fill</span><span class="p">,</span> <span class="s2">&quot;section&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">_generic_fill</span><span class="p">,</span> <span class="s2">&quot;division&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">_generic_fill</span><span class="p">,</span> <span class="s2">&quot;group&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">_class_subclass_fill</span><span class="p">)[</span><span class="n">EXPECTED_COLUMNS</span><span class="p">]</span>
        <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">companies_house_extras</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Add Companies House specific SIC codes.&quot;&quot;&quot;</span>
    <span class="n">extras</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;subclass&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;74990&quot;</span><span class="p">,</span> <span class="s2">&quot;98000&quot;</span><span class="p">,</span> <span class="s2">&quot;99999&quot;</span><span class="p">],</span>
        <span class="s2">&quot;subclass_name&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;Non-trading company&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Residents property management&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Dormant company&quot;</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">extras</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">normalise_codes</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Remove dots and slashes from SIC digits.&quot;&quot;&quot;</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">LEVELS</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">LEVELS</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">col</span><span class="p">:</span> <span class="n">col</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[./]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">_class_subclass_fill</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Fill class and subclass.</span>

<span class="sd">    More nuanced because subclasses may not exist, therefore have to be</span>
<span class="sd">    resolved at the same time of class and possible inferred from them.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Forward fill classes</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;class_name&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;class_name&quot;</span><span class="p">)]</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span>

    <span class="c1"># Backfill subclass by one</span>
    <span class="c1"># (each bfill eventually yields a duplicate row which we can drop with</span>
    <span class="c1"># `drop_duplicates` rather than tedious index accounting)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="s2">&quot;subclass&quot;</span><span class="p">,</span> <span class="s2">&quot;subclass_name&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
        <span class="p">:,</span> <span class="p">(</span><span class="s2">&quot;subclass&quot;</span><span class="p">,</span> <span class="s2">&quot;subclass_name&quot;</span><span class="p">)</span>
    <span class="p">]</span><span class="o">.</span><span class="n">bfill</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># If no subclass, derive from class by adding a zero, and using class name</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;subclass&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">subclass</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;class&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;/0&quot;</span><span class="p">,</span> <span class="n">subclass_name</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">class_name</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>  <span class="c1"># Drops dups we induced with bfill</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">_drop_notes</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Drop rows that only have either code or name - they correspond to notes.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">_generic_fill</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Ffill columns relating to `col`, dropping rows that were originally not NaN.&quot;&quot;&quot;</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_name&quot;</span><span class="p">]</span>
    <span class="n">subdf</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Indexes of rows that were originally not NaN (just labels to be propagated)</span>
    <span class="n">label_idx</span> <span class="o">=</span> <span class="n">subdf</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="n">subdf</span>
        <span class="c1"># Forward fill</span>
        <span class="o">.</span><span class="n">ffill</span><span class="p">()</span>
        <span class="c1"># Drop rows we don&#39;t need</span>
        <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">label_idx</span><span class="p">]</span>
        <span class="c1"># Join back to rest of columns</span>
        <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="p">)</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
